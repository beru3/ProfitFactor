# 曜日別・高期待値エントリーポイント選定システム 最終要件定義書

| 文書名 | 曜日別・高期待値エントリーポイント選定システム 最終要件定義書 |
| :--- | :--- |
| **作成日** | 2025年6月27日 |
| **作成者** | Claude Sonnet 4 |
| **バージョン** | 2.0 |
| **最終更新** | 実装仕様確定版 |

---

## 1. 概要

### 1.1. 背景と目的

FX取引におけるアノマリー（市場の優位性）を利用したトレード戦略は、収益機会を増大させる可能性がある。現在、複数の指標（短期・中期・長期の勝率や獲得pips）を基に緻密に分析された「レポート1（分析レポート）」と、過去の全取引履歴を格納した「レポート2（ポイント別損益明細）」が存在する。

本システムは、この高度な分析ロジックを自動化し、**「総合力が高く、かつ特定の曜日に最大のパフォーマンスを発揮するエントリーポイント」**を迅速かつ客観的に選定することを目的とする。さらに、指定されたフォーマットで分析結果を出力し、ファイル管理の自動化も実現する。

### 1.2. 用語定義

| 用語 | 定義 |
| :--- | :--- |
| **ポイント** | レポート1の1行に記載された、特定のエントリー/エグジット条件を持つ個別の売買ルール |
| **評価パターン** | ポイントを評価する基準の分類（利益効率、勝率重視、時間効率、最大利益の4種類） |
| **レポート1** | 週刊アノマリーFXレポートの分析レポート。各行が1つのポイントを表し、4つの評価パターンのランキング値を含む |
| **レポート2** | ポイント別損益明細。ポイント名とランキング値ごとの過去の全取引履歴を格納 |
| **ランキング値** | 各評価パターンでの順位（1-20位）。レポート1の評価パターン列の値 |
| **プロフィットファクター(PF)** | `総利益 ÷ |総損失|` で計算される収益効率指標。システムのコアな評価基準 |
| **分析対象期間** | レポート2のデータのうち、PF算出に実際に使用する期間。**デフォルトは直近26週間** |
| **基準日** | レポート1の配信日（毎週日曜日）。ディレクトリ名や出力ファイル名に使用 |

---

## 2. システム構成

### 2.1. ファイル構成

#### 入力ファイル（実行前）
```
project/
├── main.py
├── 週刊アノマリーFXレポート_YYYY年MM月DD日 - 分析レポート.csv
└── アノマリーFXポイント別損益明細 - ポイント別損益明細(上位20位).csv
```

#### 出力構成（実行後）
```
project/
├── main.py
├── YYYY-MM-DD/                    # 基準日フォルダ（自動作成）
│   ├── 週刊アノマリーFXレポート_YYYY年MM月DD日 - 分析レポート.csv
│   └── アノマリーFXポイント別損益明細 - ポイント別損益明細(上位20位).csv
└── output_YYYY-MM-DD.txt          # 分析結果出力ファイル
```

### 2.2. データ構造

#### レポート1（分析レポート）
- **1行 = 1ポイント**（日方向+銘柄+エントリー時刻+クローズ時刻の組み合わせ）
- **評価パターン列**：各列の値がランキング（1-20位）を表す
  - 勝率重視ポイント、利益効率ポイント、時間効率ポイント、最大利益ポイント
  - 勝率重視ポイントUS、利益効率ポイントUS、時間効率ポイントUS、最大利益ポイントUS
- **基準日列**：レポート配信日（毎週日曜日）

#### レポート2（ポイント別損益明細）
- **ポイント名**：評価パターン名（一部名称が異なる）
- **ポイント値**：ランキング（1-20）
- **取引日_曜日**：実際の取引曜日
- **損益pipsのSUM**：実際の損益

### 2.3. 名称マッピング

| レポート1 | レポート2 |
|-----------|-----------|
| 勝率重視ポイント | 勝率重視ポイント |
| 利益効率ポイント | 利益効率_STD_ポイント |
| 時間効率ポイント | 時間効率ポイント |
| 最大利益ポイント | 最大利益ポイント |
| 勝率重視ポイントUS | 勝率重視ポイントUS |
| 利益効率ポイントUS | 利益効率_STD_ポイントUS |
| 時間効率ポイントUS | 時間効率ポイントUS |
| 最大利益ポイントUS | 最大利益ポイントUS |

---

## 3. 機能要件

### 3.1. ファイル管理機能

- **要件-FILE-001**: 指定パターンのCSVファイルを自動検索できること
  - レポート1: `週刊アノマリーFXレポート_*分析レポート.csv`
  - レポート2: `アノマリーFXポイント別損益明細*ポイント別損益明細*.csv`
- **要件-FILE-002**: 基準日に基づいてディレクトリを自動作成し、CSVファイルを移動できること
- **要件-FILE-003**: 分析結果を指定フォーマットで`output_{基準日}.txt`に出力できること

### 3.2. データ取込・検証機能

- **要件-DATA-001**: レポート1およびレポート2のデータを、pandas使用で堅牢に読み込めること
- **要件-DATA-002**: 読み込み時に基本的なデータ検証とエラーハンドリングを行うこと
- **要件-DATA-003**: 処理の詳細をログ出力できること

### 3.3. 曜日別PF算出機能（第1検証フェーズ）

- **要件-PF-001**: レポート2のデータから、**分析対象期間（デフォルト26週）**のデータを正確に抽出できること
- **要件-PF-002**: 抽出したデータに基づき、ポイント名×曜日×ランキングの組み合わせで損益を集計できること
- **要件-PF-003**: 各組み合わせの曜日別プロフィットファクター(PF)を算出できること
  - 総損失が0の場合は、PFを「999.9」として扱う

### 3.4. ポイント選定機能（第2検証フェーズ）

- **要件-SELECT-001**: レポート1から基本4パターン（USは除外）の評価ポイントを抽出できること
- **要件-SELECT-002**: ランキング値（1-20）を持つポイントのみを処理対象として認識できること  
- **要件-SELECT-003**: レポート1のポイントとレポート2のPFデータを正確に紐付けできること
  - ポイント名のマッピング変換
  - ランキング値の一致確認
  - 曜日別の照合
- **要件-SELECT-004**: PFの閾値（デフォルト1.3以上）でフィルタリングできること
- **要件-SELECT-005**: 曜日ごと・評価パターンごとにPF順でランキングできること

### 3.5. 出力フォーマット機能

- **要件-OUTPUT-001**: 指定された固定フォーマットで結果を出力できること
  - 週合計ヘッダー部分
  - 曜日別セクション（月〜金）
  - 評価パターン4列の横並び表示
  - タブ区切り形式
- **要件-OUTPUT-002**: 評価パターンのアイコン表示に対応すること
  - ◾️🐝利益効率、◾️🐟勝率重視、◾️⏰時間効率、◾️🦏最大利益
- **要件-OUTPUT-003**: 各曜日の合計損益と週間合計損益を正確に計算・表示できること

### 3.6. 設定管理機能

- **要件-CONFIG-001**: 分析対象期間（週数）、PFの閾値、抽出件数などの主要パラメータを設定できること
- **要件-CONFIG-002**: 設定値をコード内で容易に変更できること

---

## 4. 非機能要件

| 項目 | 要件 |
| :--- | :--- |
| **パフォーマンス** | 全ての処理（データ取込から出力まで）が、標準的なデータ量において**3分以内**に完了すること |
| **信頼性** | 計算ロジックに誤りがなく、常に正確で再現性のある分析結果を出力すること |
| **操作性** | コマンドライン実行で、ITの専門家でなくても簡単に使用できること |
| **保守・拡張性** | 将来的なロジックの変更や、レポートのフォーマット変更に柔軟に対応できる設計とすること |
| **エラーハンドリング** | ファイル不存在、データ形式エラーなどに対して適切なエラーメッセージを表示すること |

---

## 5. 技術仕様

### 5.1. 実装言語・ライブラリ

- **言語**: Python 3.7以上
- **必須ライブラリ**: pandas（CSVデータ処理）
- **標準ライブラリ**: os, shutil, glob, datetime, logging

### 5.2. 処理フロー

1. **ファイル検索・読み込み**
   - 指定パターンでCSVファイルを自動検索
   - pandas使用でデータ読み込み
   - 基準日の抽出

2. **第1検証フェーズ：曜日別PF算出**
   - 分析対象期間でデータフィルタリング
   - ポイント名×曜日×ランキングでの損益集計
   - プロフィットファクター計算

3. **第2検証フェーズ：ポイント選定**
   - レポート1からランキングポイント抽出
   - レポート2のPFデータとの紐付け
   - 閾値フィルタリングとランキング

4. **出力処理**
   - 週間合計損益計算
   - 指定フォーマットでの結果整形
   - ファイル出力

5. **ファイル管理**
   - 基準日ディレクトリ作成
   - CSVファイル移動
   - ログ出力

### 5.3. 設定可能パラメータ

```python
FXAnalysisEngine(
    analysis_weeks=26,     # 分析対象期間（週数）
    pf_threshold=1.3,      # プロフィットファクター閾値
    max_results=10         # 最大表示件数
)
```

---

## 6. 出力仕様

### 6.1. 出力ファイル形式

- **ファイル名**: `output_{基準日}.txt`
- **文字エンコード**: UTF-8
- **区切り文字**: タブ（\t）

### 6.2. 出力フォーマット例

```
2025-06-27	◾️🐝利益効率		週合計：		111.5		◾️🐟勝率重視		週合計：		90.1		◾️⏰時間効率		週合計：		56.0		◾️🦏最大利益		週合計：		73.9
	月曜日(2025/06/27)
	通貨ペア	エントリ	クローズ	方向	順位	結果		通貨ペア	エントリ	クローズ	方向	順位	結果		通貨ペア	エントリ	クローズ	方向	順位	結果		通貨ペア	エントリ	クローズ	方向	順位	結果
1	USDJPY	8:51	8:58	Long	12	-1.8		EURJPY	10:48	10:58	Short	8	-0.3		EURJPY	10:55	10:58	Short	46	-1.9		USDJPY	8:59	9:08	Short	8	-4.9
	合計					-11.6		合計					-7.7		合計					7.0		合計					4.3

	火曜日(2025/06/24)
...
```

---

## 7. 運用方法

### 7.1. 実行手順

1. **ファイル配置**
   ```
   project/
   ├── main.py
   ├── 週刊アノマリーFXレポート_YYYY年MM月DD日 - 分析レポート.csv
   └── アノマリーFXポイント別損益明細 - ポイント別損益明細(上位20位).csv
   ```

2. **実行**
   ```bash
   python main.py
   ```

3. **結果確認**
   - `output_{基準日}.txt`ファイルで分析結果確認
   - CSVファイルは基準日フォルダに自動移動

### 7.2. ログ出力例

```
2025-06-27 10:00:00 - INFO - レポート1ファイル: 週刊アノマリーFXレポート_2025年06月27日 - 分析レポート.csv
2025-06-27 10:00:01 - INFO - レポート2ファイル: アノマリーFXポイント別損益明細 - ポイント別損益明細(上位20位).csv
2025-06-27 10:00:02 - INFO - レポート1読み込み完了: 150件
2025-06-27 10:00:03 - INFO - レポート2読み込み完了: 2500件
2025-06-27 10:00:04 - INFO - 基準日: 2025-06-27
2025-06-27 10:00:05 - INFO - 分析結果保存完了: output_2025-06-27.txt
```

---

## 8. 制約事項・注意点

### 8.1. データ制約

- レポート1には「基準日」列が必須
- レポート2には「ポイント名」「ポイント値」「取引日_曜日」「損益pipsのSUM」列が必須
- ランキング値は1-20の範囲内であること

### 8.2. ファイル制約

- CSVファイルのエンコードはUTF-8を推奨
- ファイル名は指定パターンに準拠すること

### 8.3. 免責事項

本システムが提供する情報は、あくまで過去データに基づいた分析結果であり、将来の利益を保証するものではない。最終的な投資判断は、利用者の責任において行われるものとする。

---

## 9. 版数管理

| 版数 | 更新日 | 更新内容 |
| :--- | :--- | :--- |
| 1.0 | 2025-06-26 | 初版作成 |
| 2.0 | 2025-06-27 | 実装仕様確定、ファイル名パターン対応、出力フォーマット仕様追加 |